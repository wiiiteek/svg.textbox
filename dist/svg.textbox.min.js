/*! svg.textbox.js - v1.0.0 - 2017-07-18
* https://github.com/wiiiteek/svg.textbox#readme
* Copyright (c) 2017 ; Licensed MIT */
SVG.MText=SVG.invent({create:function(){this.constructor.call(this,SVG.create("text")),this.dom.lineHeight=new SVG.Number(1.2),this.attr("font-family",SVG.defaults.attrs["font-family"]),this.data("text-width",200);var a=SVG.defaults.attrs["font-size"]?SVG.defaults.attrs["font-size"]:"12px";this.attr("font-size",a)},inherit:SVG.Shape,extend:{width:function(a){return"undefined"==typeof a?this.data("text-width"):(this.data("text-width",a),void this.breakLines(this.width()))},aligin:function(a){return"undefined"==typeof a?this.attr("text-anchor"):(this.attr("text-anchor",a),void this.adjustLines())},line:function(a){if("undefined"!=typeof a){var b=new SVG.Tspan;b.attr("newline",!0),this.node.appendChild(b.node),"function"==typeof a?a.call(this,b):b.tspan(a),this.breakLine(b,this.width()),this.adjustLines()}},adjustLines:function(){var a=0,b=0,c=this,d=this.attr("x");"middle"==this.attr("text-anchor")?d=this.attr("x")+this.width()/2:"end"==this.attr("text-anchor")&&(d=this.attr("x")+this.width()),this.lines().each(function(){var e=c.getBiggestFont(this),f=(e*c.dom.lineHeight-e)/2,g=2*b+e;this.attr("dy",g),this.attr("x",d),a=g,b=f})},breakLines:function(a){var b=this;this.connectBrokenLines(),this.lines().each(function(){b.breakLine(this,a)}),this.adjustLines()},breakLine:function(a,b){if(!(a.node instanceof SVGTSpanElement))throw Exception("Given line is not SVG Tspan element!");this.wrapPlainText(a);var c=a.node.getComputedTextLength();if(!(b>=c)){for(var d=a.node.childNodes,e=0,f=0,g=-1,h=0;h<d.length;h++){if(f++,f>100)throw Exception('Watchdog limit reached! Something is wrong with break line "for" loop!');var i=d[h];if("tspan"===i.nodeName){if(e+=i.getComputedTextLength(),!(b>e)){var j=this.breakSpanIntoTwo(i);if(null===j){g=1>h&&d.length>1?h+1:h;break}d=a.node.childNodes,h=-1,e=0}}else i.remove()}if(!(1>g)){var k=SVG.adopt(a.node.cloneNode());k.data("connected-with-line",a.id()),k.id(SVG.eid(k.node.nodeName)),a.node.parentNode.insertBefore(k.node,a.node);for(var l=[],m=0;g>m;m++)l.push(d[m]);l.map(function(a){return k.node.appendChild(a)}),this.connectBrokenWordsInLine(k),this.breakLine(a,b),this.connectBrokenWordsInLine(a),this.adjustLines()}}},breakSpanIntoTwo:function(a){var b=a.parentNode,c=a.textContent.split(" ").filter(function(a){return""!==a&&a.length>0});if(c.length<2)return null;a.innerHTML="";var d=a.cloneNode(!0);b.insertBefore(d,a.nextSibling),SVG.adopt(d).id(SVG.eid(d.nodeName)),SVG.adopt(d).data("connect-prev",!0),SVG.adopt(a).data("connect-next",!0);for(var e=0;e<c.length;e++)""!==c[e]&&(e+1<=c.length/2?a.innerHTML=a.innerHTML+c[e]+" ":d.innerHTML=d.innerHTML+c[e]+" ");return d},connectBrokenWordsInLine:function(a){for(var b=a.node.childNodes,c=0;c<b.length;c++){var d=SVG.adopt(b[c]),e=c<b.length?SVG.adopt(b[c+1]):null;d&&d.data("connect-next")&&e&&e.data("connect-prev")&&(e.node.innerHTML=d.node.innerHTML+" "+e.node.innerHTML,d.node.remove(),c--)}},connectBrokenLines:function(){for(var a=this.node.childNodes,b=a.length-1;b>=0;b--){var c=SVG.adopt(a[b]);if(c&&c.data("connected-with-line")){var d=SVG.get(c.data("connected-with-line"));d&&(d.node.innerHTML=c.node.innerHTML+d.node.innerHTML,c.node.remove())}}},wrapPlainText:function(a){var b=a.node.childNodes;if(b)for(var c=0;c<b.length;c++){var d=b[c];if("#text"===d.nodeName){var e=SVG.create("tspan");console.log("Text wprapped: "+d.textContent),e.innerHTML=d.textContent,a.node.replaceChild(e,d)}}},getBiggestFont:function(a){for(var b=parseInt(getComputedStyle(a.node)["font-size"]),c=SVG.utils.filterSVGElements(a.node.childNodes),d=c.length-1;d>=0;d--){var e=this.getBiggestFont(SVG.adopt(c[d]));b=e>b?e:b}return b},lines:function(){var a=SVG.utils.map(SVG.utils.filterSVGElements(this.node.childNodes),function(a){return SVG.adopt(a)});return new SVG.Set(a)},lineHeight:function(a){return null===a?this.dom.lineHeight:(this.dom.lineHeight=new SVG.Number(a),void this.adjustLines())}},construct:{mtext:function(){return this.put(new SVG.MText).attr("multiline",!0)}}}),SVG.extend(SVG.MText,{move:function(a,b){return this.x(a).y(b),this.adjustLines&&this.adjustLines(),this}});